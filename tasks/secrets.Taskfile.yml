# ##################################################################################################
# File: tasks/secrets.Taskfile.yml
# Description:
#   Secrets management Taskfile for fouchger-homelab.
#
# Key design goals (to stop the “recipient drift / can’t decrypt” loop):
#   1) Never hardcode keys or recipients.
#   2) The age identity file (state/secrets/age/age-key.txt) is the single source of truth.
#   3) Never recreate/overwrite an existing age identity. If it’s missing and encrypted files exist, fail fast.
#   4) Always export SOPS_AGE_KEY_FILE explicitly inside tasks that call sops.
#   5) .sops.yaml recipient is always derived from the current age identity (age-keygen -y), not from a stale file.
#   6) After creating OpenBao bootstrap, immediately self-test that sops can decrypt it (so failures surface early).
# ##################################################################################################

version: "3"

vars:
  SUDO: "{{.SUDO | default \"sudo\"}}"
  APT_GET: "{{.APT_GET | default \"apt-get\"}}"
  DEBIAN_FRONTEND: "noninteractive"

  # Repo layout
  SECRETS_DIR: "state/secrets"
  AGE_DIR: "{{.SECRETS_DIR}}/age"
  SOPS_DIR: "{{.SECRETS_DIR}}/sops"
  OPENBAO_DIR: "{{.SECRETS_DIR}}/openbao"

  # age identity paths (NOT to be committed)
  AGE_IDENTITY_FILE: "{{.AGE_DIR}}/age-key.txt"
  AGE_RECIPIENTS_FILE: "{{.AGE_DIR}}/age-recipients.txt"

  # SOPS config file (committed)
  SOPS_CONFIG_FILE: ".sops.yaml"

  # OpenBao defaults
  OPENBAO_VERSION: "{{.OPENBAO_VERSION | default \"latest\"}}"
  OPENBAO_BIN: "{{.OPENBAO_BIN | default \"bao\"}}"

  OPENBAO_USER: "openbao"
  OPENBAO_GROUP: "openbao"
  OPENBAO_CONFIG_DIR: "/etc/openbao"
  OPENBAO_DATA_DIR: "/var/lib/openbao"
  OPENBAO_SERVICE: "openbao"

  OPENBAO_LISTEN_ADDRESS: "{{.OPENBAO_LISTEN_ADDRESS | default \"0.0.0.0:8200\"}}"
  OPENBAO_API_ADDR: "{{.OPENBAO_API_ADDR | default \"https://127.0.0.1:8200\"}}"

  OPENBAO_BOOTSTRAP_ENC: "{{.OPENBAO_DIR}}/bootstrap.enc.yaml"

tasks:
  # ------------------------------------------------------------------------------------------------
  # One-liner meta task
  # ------------------------------------------------------------------------------------------------
  secrets:
    desc: "Install and set up SOPS+age, SSH keys, and OpenBao baseline (safe defaults)."
    cmds:
      - task: prereqs
      - task: dirs
      - task: age:install
      - task: sops:install
      - task: age:init
      - task: sops:init
      - task: ssh:install
      - task: ssh:keys
      - task: openbao:install
      - task: openbao:configure
      - task: openbao:service
      - task: openbao:init
      - task: openbao:login
      - task: openbao:policies:baseline:best-effort
      - task: verify
    silent: false

  # ------------------------------------------------------------------------------------------------
  # Prereqs and folder structure
  # ------------------------------------------------------------------------------------------------
  prereqs:
    desc: "Ensure base tools exist (curl, unzip, jq, openssl)."
    cmds:
      - "{{.SUDO}} {{.APT_GET}} update"
      - "{{.SUDO}} {{.APT_GET}} install -y ca-certificates curl unzip jq coreutils findutils openssl"
    status:
      - command -v curl
      - command -v unzip
      - command -v jq

  dirs:
    desc: "Create secrets folder structure (safe defaults)."
    cmds:
      - "mkdir -p {{.AGE_DIR}} {{.SOPS_DIR}} {{.OPENBAO_DIR}}"
      - "mkdir -p ansible/group_vars/all ansible/group_vars/prod ansible/group_vars/dev"
      - "chmod 700 {{.AGE_DIR}}"
      - "chmod 755 {{.SOPS_DIR}} {{.OPENBAO_DIR}}"
    status:
      - test -d "{{.AGE_DIR}}"
      - test -d "{{.SOPS_DIR}}"
      - test -d "{{.OPENBAO_DIR}}"

  # ------------------------------------------------------------------------------------------------
  # age (preferred recipient mechanism for SOPS)
  # ------------------------------------------------------------------------------------------------
  age:install:
    desc: "Install age (includes age-keygen). Prefer apt; fallback to GitHub release."
    cmds:
      - |
        set -euo pipefail

        if command -v age >/dev/null 2>&1 && command -v age-keygen >/dev/null 2>&1; then
          echo "age and age-keygen already installed."
          exit 0
        fi

        if command -v lsb_release >/dev/null 2>&1; then
          DISTRO="$(lsb_release -is || true)"
        else
          DISTRO=""
        fi

        if [ "${DISTRO}" = "Ubuntu" ]; then
          if ! grep -RhsE '^[^#].*\bubuntu.com/ubuntu\b.*\b(universe)\b' /etc/apt/sources.list /etc/apt/sources.list.d/*.list 2>/dev/null | grep -q universe; then
            echo "Enabling Ubuntu universe repository (required for age on many images)..."
            {{.SUDO}} {{.APT_GET}} update -qq || true
            {{.SUDO}} {{.APT_GET}} install -y software-properties-common
            {{.SUDO}} add-apt-repository -y universe
          fi
        fi

        {{.SUDO}} {{.APT_GET}} update
        if {{.APT_GET}} -qq show age >/dev/null 2>&1; then
          {{.SUDO}} {{.APT_GET}} install -y age
        fi

        if command -v age >/dev/null 2>&1 && command -v age-keygen >/dev/null 2>&1; then
          echo "age installed via apt."
          exit 0
        fi

        echo "Installing age from GitHub release (fallback)..."
        TMP="$(mktemp -d)"
        trap 'rm -rf "${TMP}"' EXIT

        ARCH="$(uname -m)"
        case "${ARCH}" in
          x86_64|amd64)   AGE_ARCH="linux-amd64" ;;
          aarch64|arm64)  AGE_ARCH="linux-arm64" ;;
          *)
            echo "Unsupported architecture for age fallback: ${ARCH}"
            exit 1
            ;;
        esac

        TAG="$(curl -fsSL https://api.github.com/repos/FiloSottile/age/releases/latest | jq -r '.tag_name')"
        [ -n "${TAG}" ] && [ "${TAG}" != "null" ]

        curl -fsSL -o "${TMP}/age.tar.gz" "https://github.com/FiloSottile/age/releases/download/${TAG}/age-${TAG}-${AGE_ARCH}.tar.gz"
        tar -xzf "${TMP}/age.tar.gz" -C "${TMP}"

        {{.SUDO}} install -m 0755 "${TMP}/age/age" /usr/local/bin/age
        {{.SUDO}} install -m 0755 "${TMP}/age/age-keygen" /usr/local/bin/age-keygen
    status:
      - command -v age
      - command -v age-keygen

  age:init:
    desc: "Ensure an age identity exists (never overwrite). Fail fast if missing but encrypted files exist."
    cmds:
      - |
        set -euo pipefail

        mkdir -p "{{.AGE_DIR}}"
        chmod 700 "{{.AGE_DIR}}"

        # If identity exists, do NOT recreate it.
        if [ -f "{{.AGE_IDENTITY_FILE}}" ]; then
          echo "age identity already exists: {{.AGE_IDENTITY_FILE}}"
        else
          # If encrypted files exist and we don't have the key, do not generate a new one.
          # That would create an unrecoverable mismatch with existing encrypted artefacts.
          if find "{{.SECRETS_DIR}}" ansible -type f \( -name "*.enc.yaml" -o -name "*.enc.yml" -o -name "*.enc.json" \) 2>/dev/null | grep -q .; then
            echo "Encrypted files exist, but no age identity is present on this host:"
            echo "  {{.AGE_IDENTITY_FILE}}"
            echo
            echo "Action:"
            echo "  - Restore/copy the original age-key.txt to this host (recommended), OR"
            echo "  - If this is dev and you accept data loss, delete the encrypted files and re-bootstrap."
            exit 2
          fi

          echo "Generating new age identity at {{.AGE_IDENTITY_FILE}} (no encrypted files detected)."
          age-keygen -o "{{.AGE_IDENTITY_FILE}}"
          chmod 600 "{{.AGE_IDENTITY_FILE}}"
        fi

        # Always derive recipient from the identity (single source of truth)
        PUB="$(age-keygen -y "{{.AGE_IDENTITY_FILE}}")"
        [ -n "${PUB}" ]
        echo "${PUB}" > "{{.AGE_RECIPIENTS_FILE}}"
        chmod 644 "{{.AGE_RECIPIENTS_FILE}}"

        echo "Public recipient written to {{.AGE_RECIPIENTS_FILE}}:"
        echo "  ${PUB}"
    status:
      - test -f "{{.AGE_IDENTITY_FILE}}"
      - test -f "{{.AGE_RECIPIENTS_FILE}}"

  # ------------------------------------------------------------------------------------------------
  # SOPS
  # ------------------------------------------------------------------------------------------------
  sops:install:
    desc: "Install SOPS (prefers apt; falls back to GitHub release)."
    cmds:
      - |
        set -euo pipefail
        if command -v sops >/dev/null 2>&1; then
          echo "sops already installed."
          exit 0
        fi

        if {{.APT_GET}} -qq show sops >/dev/null 2>&1; then
          {{.SUDO}} {{.APT_GET}} install -y sops
          exit 0
        fi

        echo "Installing sops from GitHub latest release..."
        TMP="$(mktemp -d)"
        trap 'rm -rf "${TMP}"' EXIT

        TAG="$(curl -fsSL https://api.github.com/repos/getsops/sops/releases/latest | jq -r '.tag_name')"
        [ -n "${TAG}" ] && [ "${TAG}" != "null" ]

        ARCH="$(uname -m)"
        case "${ARCH}" in
          x86_64|amd64)   ASSET="sops-${TAG}.linux.amd64" ;;
          aarch64|arm64)  ASSET="sops-${TAG}.linux.arm64" ;;
          *)
            echo "Unsupported architecture for SOPS fallback install: ${ARCH}"
            exit 1
            ;;
        esac

        curl -fsSL -o "${TMP}/sops" "https://github.com/getsops/sops/releases/download/${TAG}/${ASSET}"
        chmod +x "${TMP}/sops"
        {{.SUDO}} install -m 0755 "${TMP}/sops" /usr/local/bin/sops
    status:
      - command -v sops

  sops:init:
    desc: "Create or update .sops.yaml using the current age identity as source of truth."
    cmds:
      - |
        set -euo pipefail

        command -v sops >/dev/null 2>&1 || { echo "Missing sops."; exit 1; }
        command -v age-keygen >/dev/null 2>&1 || { echo "Missing age-keygen."; exit 1; }

        if [ ! -f "{{.AGE_IDENTITY_FILE}}" ]; then
          echo "Missing age identity: {{.AGE_IDENTITY_FILE}} (run: task secrets:age:init)"
          exit 1
        fi

        RECIPIENT="$(age-keygen -y "{{.AGE_IDENTITY_FILE}}")"
        [ -n "${RECIPIENT}" ]

        # Always write age recipients as a list (future-proof, multi-admin ready).
        {
          echo "# ##################################################################################################"
          echo "# File: .sops.yaml"
          echo "# Purpose:"
          echo "#   SOPS encryption rules for fouchger-homelab."
          echo "# Notes:"
          echo "#   - Recipient is derived from state/secrets/age/age-key.txt (single source of truth)."
          echo "# ##################################################################################################"
          echo ""
          echo "creation_rules:"
          echo "  - path_regex: ^state/secrets/sops/.*\\.(ya?ml|json|env|ini)$"
          echo "    encrypted_regex: '^(data|stringData|secrets|secret|token|password|key|keys|private|config)$'"
          echo "    age: [\"${RECIPIENT}\"]"
          echo ""
          echo "  - path_regex: ^ansible/group_vars/.*/.*(secret|secrets)\\.(ya?ml|json)$"
          echo "    age: [\"${RECIPIENT}\"]"
          echo ""
          echo "  - path_regex: ^state/secrets/openbao/.*(\\.enc)?\\.(ya?ml|json)$"
          echo "    age: [\"${RECIPIENT}\"]"
        } > "{{.SOPS_CONFIG_FILE}}"

        echo "Wrote {{.SOPS_CONFIG_FILE}} with recipient:"
        echo "  ${RECIPIENT}"

        if [ ! -f ".gitignore" ]; then
          touch .gitignore
        fi

        if ! grep -qE '^state/secrets/age/' .gitignore; then
          {
            echo ""
            echo "# Secrets tooling private material (do not commit)"
            echo "state/secrets/age/"
          } >> .gitignore
        fi

        if [ ! -f "{{.SOPS_DIR}}/README.md" ]; then
          {
            echo "# Encrypted secrets (SOPS)"
            echo ""
            echo "Store Git-encrypted configuration state here (YAML/JSON/ENV/INI)."
            echo ""
            echo "Do not store age private keys here. Those live under state/secrets/age/ which is ignored by Git."
          } > "{{.SOPS_DIR}}/README.md"
        fi

  sops:encrypt:
    desc: "Encrypt a file in-place with SOPS (usage: task secrets:sops:encrypt -- FILE=path)."
    vars:
      FILE: "{{.FILE}}"
    cmds:
      - |
        set -euo pipefail
        [ -n "{{.FILE}}" ] || (echo "FILE is required, e.g. task secrets:sops:encrypt -- FILE=state/secrets/sops/app.yaml" && exit 1)
        export SOPS_AGE_KEY_FILE="{{.AGE_IDENTITY_FILE}}"
        sops -e -i "{{.FILE}}"

  sops:decrypt:
    desc: "Decrypt a file to stdout (usage: task secrets:sops:decrypt -- FILE=path)."
    vars:
      FILE: "{{.FILE}}"
    cmds:
      - |
        set -euo pipefail
        [ -n "{{.FILE}}" ] || (echo "FILE is required, e.g. task secrets:sops:decrypt -- FILE=state/secrets/sops/app.yaml" && exit 1)
        export SOPS_AGE_KEY_FILE="{{.AGE_IDENTITY_FILE}}"
        sops -d "{{.FILE}}"

  sops:rotate:
    desc: "Add this host’s recipient to existing encrypted files (requires decrypt access)."
    cmds:
      - |
        set -euo pipefail
        export SOPS_AGE_KEY_FILE="{{.AGE_IDENTITY_FILE}}"
        command -v sops >/dev/null 2>&1 || { echo "Missing sops."; exit 1; }
        command -v age-keygen >/dev/null 2>&1 || { echo "Missing age-keygen."; exit 1; }

        RECIPIENT="$(age-keygen -y "{{.AGE_IDENTITY_FILE}}")"
        [ -n "${RECIPIENT}" ]

        echo "Adding recipient to encrypted files:"
        echo "  ${RECIPIENT}"

        find "{{.SECRETS_DIR}}" ansible -type f \( -name "*.enc.yaml" -o -name "*.enc.yml" -o -name "*.enc.json" \) -print0 \
          | while IFS= read -r -d '' f; do
              echo "Rotating: ${f}"
              sops -r "${RECIPIENT}" -i "${f}"
            done

  # ------------------------------------------------------------------------------------------------
  # SSH keys
  # ------------------------------------------------------------------------------------------------
  ssh:install:
    desc: "Install SSH client tooling and optional helper utilities."
    cmds:
      - "{{.SUDO}} {{.APT_GET}} update"
      - "{{.SUDO}} {{.APT_GET}} install -y openssh-client openssh-server keychain"
    status:
      - command -v ssh
      - command -v ssh-keygen
      - command -v keychain

  ssh:keys:
    desc: "Create SSH keys (ed25519) for the current user if missing."
    vars:
      SSH_KEY: "{{.SSH_KEY | default (printf \"%s/.ssh/id_ed25519\" .HOME)}}"
      SSH_COMMENT: "{{.SSH_COMMENT | default \"fouchger-homelab\"}}"
    cmds:
      - |
        set -euo pipefail

        mkdir -p "$(dirname "{{.SSH_KEY}}")"
        chmod 700 "$(dirname "{{.SSH_KEY}}")"

        if [ -f "{{.SSH_KEY}}" ]; then
          echo "SSH key already exists: {{.SSH_KEY}}"
        else
          echo "Creating SSH key: {{.SSH_KEY}}"
          echo "You will be prompted for a passphrase (recommended)."
          ssh-keygen -t ed25519 -a 64 -C "{{.SSH_COMMENT}}" -f "{{.SSH_KEY}}"
          chmod 600 "{{.SSH_KEY}}"
          chmod 644 "{{.SSH_KEY}}.pub"
        fi

        echo
        echo "Public key:"
        cat "{{.SSH_KEY}}.pub"
        echo

        if command -v keychain >/dev/null 2>&1; then
          if [ -f "${HOME}/.bashrc" ] && ! grep -q "keychain.*id_ed25519" "${HOME}/.bashrc"; then
            {
              echo ""
              echo "# fouchger-homelab: SSH agent convenience (headless friendly)"
              echo "# Keychain manages an ssh-agent across sessions."
              echo "if command -v keychain >/dev/null 2>&1; then"
              echo "  eval \"$(keychain --eval --quiet id_ed25519)\""
              echo "fi"
            } >> "${HOME}/.bashrc"
            echo "Updated ~/.bashrc with keychain snippet (effective on next shell start)."
          fi
        fi

  # ------------------------------------------------------------------------------------------------
  # OpenBao
  # ------------------------------------------------------------------------------------------------
  openbao:install:
    desc: "Install OpenBao CLI/server (prefers .deb; falls back to snap)."
    cmds:
      - |
        set -euo pipefail

        if command -v bao >/dev/null 2>&1; then
          echo "OpenBao already installed (bao on PATH)."
          exit 0
        fi

        if command -v openbao >/dev/null 2>&1; then
          echo "OpenBao detected as 'openbao'. Creating /usr/local/bin/bao symlink..."
          {{.SUDO}} install -d /usr/local/bin
          {{.SUDO}} ln -sf "$(command -v openbao)" /usr/local/bin/bao
          command -v bao >/dev/null 2>&1
          echo "OpenBao ready (openbao -> bao)."
          exit 0
        fi

        {{.SUDO}} {{.APT_GET}} update
        {{.SUDO}} {{.APT_GET}} install -y ca-certificates curl jq

        if [ "{{.OPENBAO_VERSION}}" = "latest" ]; then
          TAG="$(curl -fsSL https://api.github.com/repos/openbao/openbao/releases/latest | jq -r '.tag_name')"
        else
          TAG="{{.OPENBAO_VERSION}}"
        fi
        [ -n "${TAG}" ] && [ "${TAG}" != "null" ]

        ARCH="$(uname -m)"
        case "${ARCH}" in
          x86_64|amd64)   DEB_ARCH="amd64" ;;
          aarch64|arm64)  DEB_ARCH="arm64" ;;
          *)
            echo "Unsupported architecture for OpenBao: ${ARCH}"
            exit 1
            ;;
        esac

        echo "Attempting .deb install for OpenBao ${TAG} (${DEB_ARCH})..."

        DEB_URL="$(
          curl -fsSL "https://api.github.com/repos/openbao/openbao/releases/tags/${TAG}" \
          | jq -r --arg arch "${DEB_ARCH}" '
              .assets[]
              | select(.browser_download_url | test("linux.*" + $arch + ".*\\.deb$"))
              | .browser_download_url
            ' | head -n 1
        )"

        if [ -n "${DEB_URL}" ] && [ "${DEB_URL}" != "null" ]; then
          TMP="$(mktemp -d)"
          trap 'rm -rf "${TMP}"' EXIT

          DEB_FILE="${TMP}/openbao-${TAG#v}-linux-${DEB_ARCH}.deb"
          echo "Downloading: ${DEB_URL}"
          curl -fsSL -o "${DEB_FILE}" "${DEB_URL}"

          {{.SUDO}} dpkg -i "${DEB_FILE}" || true
          {{.SUDO}} {{.APT_GET}} install -f -y

          if command -v bao >/dev/null 2>&1; then
            echo "OpenBao installed via .deb (bao available)."
            exit 0
          fi

          if command -v openbao >/dev/null 2>&1; then
            {{.SUDO}} install -d /usr/local/bin
            {{.SUDO}} ln -sf "$(command -v openbao)" /usr/local/bin/bao
            command -v bao >/dev/null 2>&1
            echo "OpenBao installed via .deb (openbao -> bao)."
            exit 0
          fi

          echo "Installed .deb but neither 'bao' nor 'openbao' found. Check package contents."
          exit 1
        fi

        echo "No matching .deb asset found for ${TAG} (${DEB_ARCH}). Falling back to snap..."

        if ! command -v snap >/dev/null 2>&1; then
          {{.SUDO}} {{.APT_GET}} install -y snapd
        fi

        if [ -d /snap/bin ] && ! echo "${PATH}" | grep -q "/snap/bin"; then
          export PATH="${PATH}:/snap/bin"
        fi

        {{.SUDO}} snap install openbao

        if command -v bao >/dev/null 2>&1; then
          echo "OpenBao installed via snap (bao available)."
          exit 0
        fi

        if command -v openbao >/dev/null 2>&1; then
          {{.SUDO}} install -d /usr/local/bin
          {{.SUDO}} ln -sf "$(command -v openbao)" /usr/local/bin/bao
          command -v bao >/dev/null 2>&1
          echo "OpenBao installed via snap (openbao -> bao)."
          exit 0
        fi

        if [ -x /snap/bin/openbao ]; then
          {{.SUDO}} install -d /usr/local/bin
          {{.SUDO}} ln -sf /snap/bin/openbao /usr/local/bin/bao
          command -v bao >/dev/null 2>&1
          echo "OpenBao installed via snap (/snap/bin/openbao -> bao)."
          exit 0
        fi

        echo "OpenBao installed but CLI not found on PATH. Log out/in or restart, then retry."
        exit 1
    status:
      - command -v bao

  openbao:configure:
    desc: "Create OpenBao user, directories, and baseline config (file storage, TLS listener)."
    cmds:
      - |
        set -euo pipefail

        if ! getent group "{{.OPENBAO_GROUP}}" >/dev/null; then
          {{.SUDO}} groupadd --system "{{.OPENBAO_GROUP}}"
        fi
        if ! id -u "{{.OPENBAO_USER}}" >/dev/null 2>&1; then
          {{.SUDO}} useradd --system --home "{{.OPENBAO_DATA_DIR}}" --shell /usr/sbin/nologin --gid "{{.OPENBAO_GROUP}}" "{{.OPENBAO_USER}}"
        fi

        {{.SUDO}} mkdir -p "{{.OPENBAO_CONFIG_DIR}}" "{{.OPENBAO_DATA_DIR}}"
        {{.SUDO}} chown -R "{{.OPENBAO_USER}}:{{.OPENBAO_GROUP}}" "{{.OPENBAO_CONFIG_DIR}}" "{{.OPENBAO_DATA_DIR}}"
        {{.SUDO}} chmod 750 "{{.OPENBAO_CONFIG_DIR}}" "{{.OPENBAO_DATA_DIR}}"

        {{.SUDO}} mkdir -p "{{.OPENBAO_CONFIG_DIR}}/tls"
        {{.SUDO}} chown -R "{{.OPENBAO_USER}}:{{.OPENBAO_GROUP}}" "{{.OPENBAO_CONFIG_DIR}}/tls"
        {{.SUDO}} chmod 750 "{{.OPENBAO_CONFIG_DIR}}/tls"

        if [ ! -f "{{.OPENBAO_CONFIG_DIR}}/tls/openbao.crt" ] || [ ! -f "{{.OPENBAO_CONFIG_DIR}}/tls/openbao.key" ]; then
          echo "Generating self-signed TLS cert for OpenBao (homelab default)..."
          TMPDIR="$(mktemp -d)"
          trap 'rm -rf "${TMPDIR}"' EXIT

          openssl req -x509 -newkey rsa:4096 -sha256 -days 825 -nodes \
            -keyout "${TMPDIR}/openbao.key" \
            -out "${TMPDIR}/openbao.crt" \
            -subj "/CN=openbao" \
            -addext "subjectAltName=DNS:openbao,DNS:localhost,IP:127.0.0.1"

          {{.SUDO}} install -m 0640 -o "{{.OPENBAO_USER}}" -g "{{.OPENBAO_GROUP}}" "${TMPDIR}/openbao.key" "{{.OPENBAO_CONFIG_DIR}}/tls/openbao.key"
          {{.SUDO}} install -m 0644 -o "{{.OPENBAO_USER}}" -g "{{.OPENBAO_GROUP}}" "${TMPDIR}/openbao.crt" "{{.OPENBAO_CONFIG_DIR}}/tls/openbao.crt"
        fi

        {
          echo "# ##################################################################################################"
          echo "# File: /etc/openbao/openbao.hcl"
          echo "# Purpose:"
          echo "#   Baseline OpenBao configuration for a homelab (TLS enabled)."
          echo "# Notes:"
          echo "#   - Self-signed TLS by default. Replace with internal CA when ready."
          echo "# ##################################################################################################"
          echo ""
          echo "ui = true"
          echo "api_addr = \"{{.OPENBAO_API_ADDR}}\""
          echo ""
          echo "storage \"file\" {"
          echo "  path = \"{{.OPENBAO_DATA_DIR}}\""
          echo "}"
          echo ""
          echo "listener \"tcp\" {"
          echo "  address = \"{{.OPENBAO_LISTEN_ADDRESS}}\""
          echo "  tls_disable = 0"
          echo "  tls_cert_file = \"{{.OPENBAO_CONFIG_DIR}}/tls/openbao.crt\""
          echo "  tls_key_file  = \"{{.OPENBAO_CONFIG_DIR}}/tls/openbao.key\""
          echo "}"
        } > /tmp/openbao.hcl

        {{.SUDO}} install -m 0640 -o "{{.OPENBAO_USER}}" -g "{{.OPENBAO_GROUP}}" /tmp/openbao.hcl "{{.OPENBAO_CONFIG_DIR}}/openbao.hcl"
        rm -f /tmp/openbao.hcl

  openbao:service:
    desc: "Install and start systemd service for OpenBao."
    cmds:
      - |
        set -euo pipefail

        if [ ! -d /etc/systemd/system ]; then
          echo "systemd not detected. Use OpenBao in dev mode or container mode on this host."
          exit 1
        fi

        if ! command -v "{{.OPENBAO_BIN}}" >/dev/null 2>&1; then
          echo "OpenBao CLI '{{.OPENBAO_BIN}}' not found on PATH. Run: task secrets:openbao:install"
          exit 1
        fi

        if [ ! -f "/etc/systemd/system/{{.OPENBAO_SERVICE}}.service" ]; then
          {
            echo "# ##################################################################################################"
            echo "# File: /etc/systemd/system/openbao.service"
            echo "# Purpose:"
            echo "#   Run OpenBao as a service."
            echo "# Notes:"
            echo "#   - Uses /usr/bin/env to avoid hard-coding the bao binary path."
            echo "# ##################################################################################################"
            echo "[Unit]"
            echo "Description=OpenBao"
            echo "After=network-online.target"
            echo "Wants=network-online.target"
            echo ""
            echo "[Service]"
            echo "User={{.OPENBAO_USER}}"
            echo "Group={{.OPENBAO_GROUP}}"
            echo "ExecStart=/usr/bin/env {{.OPENBAO_BIN}} server -config={{.OPENBAO_CONFIG_DIR}}/openbao.hcl"
            echo "ExecReload=/bin/kill --signal HUP \$MAINPID"
            echo "KillMode=process"
            echo "KillSignal=SIGINT"
            echo "Restart=on-failure"
            echo "RestartSec=5"
            echo "LimitNOFILE=65536"
            echo "NoNewPrivileges=yes"
            echo "PrivateTmp=yes"
            echo "ProtectSystem=full"
            echo "ProtectHome=yes"
            echo "MemorySwapMax=0"
            echo ""
            echo "[Install]"
            echo "WantedBy=multi-user.target"
          } > /tmp/openbao.service
          {{.SUDO}} install -m 0644 /tmp/openbao.service "/etc/systemd/system/{{.OPENBAO_SERVICE}}.service"
          rm -f /tmp/openbao.service
        fi

        {{.SUDO}} systemctl daemon-reload
        {{.SUDO}} systemctl restart "{{.OPENBAO_SERVICE}}" || true
        {{.SUDO}} systemctl enable --now "{{.OPENBAO_SERVICE}}"
        {{.SUDO}} systemctl --no-pager status "{{.OPENBAO_SERVICE}}" || true

  openbao:init:
    desc: "Initialise OpenBao if not initialised, then store bootstrap info as SOPS-encrypted YAML (TLS)."
    cmds:
      - |
        set -euo pipefail

        export BAO_ADDR="{{.OPENBAO_API_ADDR}}"
        export BAO_SKIP_VERIFY="${BAO_SKIP_VERIFY:-true}"

        # Always force SOPS to use the repo’s age identity.
        export SOPS_AGE_KEY_FILE="{{.AGE_IDENTITY_FILE}}"

        command -v bao >/dev/null 2>&1 || { echo "Missing 'bao' on PATH."; exit 1; }
        command -v sops >/dev/null 2>&1 || { echo "Missing 'sops' on PATH."; exit 1; }
        command -v jq  >/dev/null 2>&1 || { echo "Missing 'jq' on PATH."; exit 1; }
        command -v age-keygen >/dev/null 2>&1 || { echo "Missing 'age-keygen' on PATH."; exit 1; }

        if [ ! -f "{{.AGE_IDENTITY_FILE}}" ]; then
          echo "Missing age identity: {{.AGE_IDENTITY_FILE}} (run: task secrets:age:init)"
          exit 1
        fi

        mkdir -p "{{.OPENBAO_DIR}}"
        chmod 755 "{{.OPENBAO_DIR}}"

        # Wait for API responsiveness.
        for i in $(seq 1 30); do
          if bao status -format=json >/dev/null 2>&1; then
            break
          fi
          sleep 1
        done

        STATUS_JSON="$(bao status -format=json 2>/dev/null || true)"
        if [ -z "${STATUS_JSON}" ]; then
          echo "OpenBao API not responding at ${BAO_ADDR}. Check service status and TLS settings."
          exit 1
        fi

        INITIALIZED="$(printf '%s' "${STATUS_JSON}" | jq -r '.initialized // false')"

        if [ "${INITIALIZED}" = "true" ]; then
          if [ -f "{{.OPENBAO_BOOTSTRAP_ENC}}" ]; then
            # If it exists, prove we can decrypt it (otherwise fail with a clear message).
            if sops -d "{{.OPENBAO_BOOTSTRAP_ENC}}" >/dev/null 2>&1; then
              echo "OpenBao already initialised and bootstrap file is decryptable: {{.OPENBAO_BOOTSTRAP_ENC}}"
              exit 0
            fi
            echo "OpenBao already initialised but bootstrap file is not decryptable on this host:"
            echo "  {{.OPENBAO_BOOTSTRAP_ENC}}"
            echo "Restore the correct age-key.txt for this repo, or reset OpenBao storage (dev only)."
            exit 2
          fi

          echo "OpenBao is already initialised, but no bootstrap file found at:"
          echo "  {{.OPENBAO_BOOTSTRAP_ENC}}"
          echo
          echo "If this is non-production, wipe the storage backend and reinitialise."
          exit 2
        fi

        # Not initialised, but bootstrap exists is suspicious; refuse to overwrite.
        if [ -f "{{.OPENBAO_BOOTSTRAP_ENC}}" ]; then
          echo "Refusing to initialise: bootstrap file already exists at:"
          echo "  {{.OPENBAO_BOOTSTRAP_ENC}}"
          exit 2
        fi

        echo "Initialising OpenBao (this will generate unseal keys and initial root token)."

        INIT_JSON="$(bao operator init -format=json -key-shares=5 -key-threshold=3)"
        [ -n "${INIT_JSON}" ]

        PLAINFILE="{{.OPENBAO_DIR}}/bootstrap.plain.yaml"
        PLAIN_TMP="$(mktemp -p "{{.OPENBAO_DIR}}" "bootstrap.plain.tmp.XXXXXX.yaml")"
        chmod 600 "${PLAIN_TMP}"

        TMPENC="$(mktemp -p "{{.OPENBAO_DIR}}" "bootstrap.tmp.XXXXXX.enc.yaml")"
        trap 'rm -f "${TMPENC}" "${PLAIN_TMP:-}"' EXIT

        {
          echo "# ################################################################################################"
          echo "# File: ${PLAINFILE}"
          echo "# Purpose:"
          echo "#   Plaintext OpenBao bootstrap artefact (unseal keys + initial root token)."
          echo "# Notes:"
          echo "#   - Sensitive. Retained only if KEEP_PLAINTEXT_BOOTSTRAP=1."
          echo "# ################################################################################################"
          echo "openbao:"
          echo "  addr: \"{{.OPENBAO_API_ADDR}}\""
          echo "  generated_at_utc: \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\""
          echo "  init:"
          echo "    key_shares: 5"
          echo "    key_threshold: 3"
          echo "    json: |"
          echo "${INIT_JSON}" | sed 's/^/      /'
        } > "${PLAIN_TMP}"

        mv -f "${PLAIN_TMP}" "${PLAINFILE}"
        chmod 600 "${PLAINFILE}"

        cp -f "${PLAINFILE}" "${TMPENC}"
        sops -e -i "${TMPENC}"
        mv "${TMPENC}" "{{.OPENBAO_BOOTSTRAP_ENC}}"

        # Self-test: prove we can decrypt what we just wrote (prevents silent drift).
        if ! sops -d "{{.OPENBAO_BOOTSTRAP_ENC}}" >/dev/null 2>&1; then
          echo "Bootstrap was written but is not decryptable with current age identity."
          echo "This indicates a miswired SOPS setup. Refusing to continue."
          exit 2
        fi

        echo "Encrypted bootstrap saved to: {{.OPENBAO_BOOTSTRAP_ENC}}"

        if [ "${KEEP_PLAINTEXT_BOOTSTRAP:-0}" = "1" ]; then
          echo "KEEP_PLAINTEXT_BOOTSTRAP=1 set; retaining plaintext at: ${PLAINFILE}"
        else
          rm -f "${PLAINFILE}"
          echo "Plaintext bootstrap removed (default behaviour)."
        fi

  openbao:policies:baseline:
    desc: "Create baseline secret engines and a starter policy (requires OpenBao unsealed + operator login)."
    cmds:
      - |
        set -euo pipefail
        export BAO_ADDR="{{.OPENBAO_API_ADDR}}"
        export BAO_SKIP_VERIFY="${BAO_SKIP_VERIFY:-true}"

        if ! bao token lookup >/dev/null 2>&1; then
          echo "Not logged in to OpenBao. Run: bao login (after unseal) and re-run this task."
          exit 1
        fi

        bao secrets enable -path=kv kv-v2 >/dev/null 2>&1 || true
        bao secrets enable pki >/dev/null 2>&1 || true
        bao secrets tune -max-lease-ttl=8760h pki >/dev/null 2>&1 || true

        {{.SUDO}} mkdir -p /var/log/openbao
        {{.SUDO}} chown "{{.OPENBAO_USER}}:{{.OPENBAO_GROUP}}" /var/log/openbao
        {{.SUDO}} chmod 750 /var/log/openbao

        bao audit enable file file_path=/var/log/openbao/audit.log >/dev/null 2>&1 || true

        TMPPOL="$(mktemp)"
        trap 'rm -f "${TMPPOL}"' EXIT
        {
          echo "# Baseline admin policy (starter). Tighten or split duties as the admin team grows."
          echo "path \"sys/health\" { capabilities = [\"read\", \"sudo\"] }"
          echo "path \"sys/mounts\" { capabilities = [\"read\", \"list\"] }"
          echo "path \"sys/mounts/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\", \"sudo\"] }"
          echo "path \"auth/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\", \"sudo\"] }"
          echo "path \"sys/policies/acl/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\", \"sudo\"] }"
          echo "path \"kv/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\"] }"
          echo "path \"pki/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\", \"sudo\"] }"
        } > "${TMPPOL}"

        bao policy write homelab-admin "${TMPPOL}"
        echo "Baseline engines enabled (kv-v2, pki, file audit) and policy homelab-admin created."

  openbao:policies:baseline:best-effort:
    desc: "Best-effort baseline policy setup. Skips (with guidance) if OpenBao is not unsealed/logged in."
    cmds:
      - |
        set -euo pipefail
        export BAO_ADDR="{{.OPENBAO_API_ADDR}}"
        export BAO_SKIP_VERIFY="${BAO_SKIP_VERIFY:-true}"
        export SOPS_AGE_KEY_FILE="{{.AGE_IDENTITY_FILE}}"

        if ! bao status >/dev/null 2>&1; then
          echo "OpenBao not reachable at ${BAO_ADDR}. Ensure the service is running:"
          echo "  sudo systemctl status {{.OPENBAO_SERVICE}}"
          exit 0
        fi

        if bao status -format=json 2>/dev/null | jq -e '.sealed == true' >/dev/null; then
          echo "OpenBao is sealed. Unseal (3 keys), then login, then run:"
          echo "  task secrets:openbao:policies:baseline"
          exit 0
        fi

        if ! bao token lookup >/dev/null 2>&1; then
          echo "OpenBao is unsealed, but you are not logged in."
          echo "Next steps:"
          echo "  1) Decrypt bootstrap: task secrets:sops:decrypt -- FILE={{.OPENBAO_BOOTSTRAP_ENC}}"
          echo "  2) Login: bao login"
          echo "  3) Apply baseline: task secrets:openbao:policies:baseline"
          exit 0
        fi

        task secrets:openbao:policies:baseline

  verify:
    desc: "Verify installs and print operator-friendly status."
    cmds:
      - |
        set -euo pipefail
        echo "Tooling:"
        command -v age >/dev/null && echo "  age:   $(age --version 2>/dev/null || true)"
        command -v sops >/dev/null && echo "  sops:  $(sops --version 2>/dev/null | head -n 1 || true)"
        command -v bao >/dev/null && echo "  bao:   $(bao version 2>/dev/null || true)"
        command -v ssh >/dev/null && echo "  ssh:   $(ssh -V 2>&1 | head -n 1 || true)"
        echo
        echo "Repo structure:"
        test -f "{{.SOPS_CONFIG_FILE}}" && echo "  {{.SOPS_CONFIG_FILE}}: present"
        test -f "{{.AGE_IDENTITY_FILE}}" && echo "  {{.AGE_IDENTITY_FILE}}: present (private, not committed)"
        test -f "{{.AGE_RECIPIENTS_FILE}}" && echo "  {{.AGE_RECIPIENTS_FILE}}: present (derived from identity)"
        test -f "{{.OPENBAO_BOOTSTRAP_ENC}}" && echo "  {{.OPENBAO_BOOTSTRAP_ENC}}: present (encrypted)"
        echo
        echo "OpenBao service:"
        if command -v systemctl >/dev/null 2>&1; then
          systemctl is-enabled "{{.OPENBAO_SERVICE}}" >/dev/null 2>&1 && echo "  enabled: yes" || echo "  enabled: no"
          systemctl is-active "{{.OPENBAO_SERVICE}}" >/dev/null 2>&1 && echo "  active:  yes" || echo "  active:  no"
        else
          echo "  systemd not detected."
        fi
        
# ------------------------------------------------------------------------------------------------
  # OpenBao operator login helper (interactive)
  # ------------------------------------------------------------------------------------------------
  openbao:login:
    desc: "Run scripts/openbao-login.sh to unseal (if needed) and login using the encrypted bootstrap."
    interactive: true
    cmds:
      - |
        set -euo pipefail

        if [ ! -f "scripts/openbao-login.sh" ]; then
          echo "Missing script: scripts/openbao-login.sh"
          exit 1
        fi

        # Provide the script with repo-correct paths and env vars.
        export ROOT_DIR="$(pwd)"
        export AGE_KEY_FILE="{{.AGE_IDENTITY_FILE}}"
        export BOOTSTRAP_ENC="{{.OPENBAO_BOOTSTRAP_ENC}}"
        export BAO_ADDR="{{.OPENBAO_API_ADDR}}"
        export SOPS_AGE_KEY_FILE="{{.AGE_IDENTITY_FILE}}"

        bash scripts/openbao-login.sh