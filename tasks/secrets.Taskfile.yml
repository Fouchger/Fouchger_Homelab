# ##################################################################################################
# File: tasks/secrets.Taskfile.yml
# Description:
#   Secrets management Taskfile for fouchger-homelab.
#
#   This Taskfile standardises two complementary patterns:
#     1) SOPS + age for Git-encrypted configuration state:
#        - API keys rotated manually
#        - App config secrets not generated on demand
#        - Ansible inventory/group_vars and similar configuration state
#
#     2) OpenBao for dynamic and centrally governed secrets:
#        - Database credentials issued with TTL
#        - PKI/cert issuance, short-lived tokens
#        - Central audit trail and policy-based access (multi-admin ready)
#
# Notes:
#   - Debian/Ubuntu oriented (works well on Ubuntu 24.04 in VMs/LXCs).
#   - This file is designed to be safe for headless use.
#   - It creates opinionated defaults but keeps “break glass” options explicit.
#
# Repo conventions created by this Taskfile:
#   - state/secrets/age/                 (age keys, not committed)
#   - state/secrets/sops/                (encrypted config state, optionally committed if you un-ignore state/)
#   - state/secrets/openbao/             (OpenBao config + encrypted bootstrap artefacts)
#   - ansible/group_vars/...       (encrypted with SOPS where appropriate)
#   - .sops.yaml                   (SOPS rules)
#
# Hardening guidance (recommended):
#   - Keep age identity private keys off Git and off shared filesystems.
#   - Use SOPS rules that force encryption for secrets paths.
#   - For OpenBao, enable TLS and prefer a real CA chain (step-ca / internal PKI) over skip-verify.
#
# Change log:
#   - 2026-03-01:
#     - Fix OpenBao systemd ExecStart path issue (203/EXEC) by avoiding hard-coded /usr/local/bin/bao.
#     - Move OpenBao defaults to HTTPS (Option B).
#     - Add homelab TLS behaviour for bootstrap workflows:
#       - Uses https://127.0.0.1:8200 by default
#       - Sets BAO_SKIP_VERIFY=true for initial bootstrap tasks (self-signed / local TLS)
#       - Clear upgrade path to BAO_CACERT once you introduce an internal CA.
#     - Fix SOPS creation_rules mismatch for OpenBao bootstrap files named *.enc.yaml
#       by updating the .sops.yaml OpenBao rule to match (\.enc)?\.(ya?ml|json).
# ##################################################################################################

version: "3"

vars:
  SUDO: "{{.SUDO | default \"sudo\"}}"
  APT_GET: "{{.APT_GET | default \"apt-get\"}}"
  DEBIAN_FRONTEND: "noninteractive"

  # Repo layout
  # NOTE:
  #   This project standardises on state/secrets to keep sensitive material out of the repo root.
  #   A compatibility symlink (./secrets -> ./state/secrets) is created by task: dirs.
  SECRETS_DIR: "state/secrets"
  AGE_DIR: "{{.SECRETS_DIR}}/age"
  SOPS_DIR: "{{.SECRETS_DIR}}/sops"
  OPENBAO_DIR: "{{.SECRETS_DIR}}/openbao"

  # age identity paths (NOT to be committed)
  AGE_IDENTITY_FILE: "{{.AGE_DIR}}/age-key.txt"
  AGE_RECIPIENTS_FILE: "{{.AGE_DIR}}/age-recipients.txt"

  # SOPS config file (committed)
  SOPS_CONFIG_FILE: ".sops.yaml"

  # OpenBao defaults (adjust for your topology)
  OPENBAO_VERSION: "{{.OPENBAO_VERSION | default \"latest\"}}"

  # IMPORTANT:
  #   Do not hard-code a filesystem path here. Different install methods place the binary in different locations.
  #   The systemd unit will call it via /usr/bin/env so it resolves from systemd PATH.
  OPENBAO_BIN: "{{.OPENBAO_BIN | default \"bao\"}}"

  OPENBAO_USER: "openbao"
  OPENBAO_GROUP: "openbao"
  OPENBAO_CONFIG_DIR: "/etc/openbao"
  OPENBAO_DATA_DIR: "/var/lib/openbao"
  OPENBAO_SERVICE: "openbao"

  # Listener defaults: Option B (TLS enabled).
  # NOTE:
  #   This Taskfile assumes a local TLS listener. Bootstrap tasks set BAO_SKIP_VERIFY=true by default.
  #   When you introduce a real CA, replace BAO_SKIP_VERIFY with BAO_CACERT.
  OPENBAO_LISTEN_ADDRESS: "{{.OPENBAO_LISTEN_ADDRESS | default \"0.0.0.0:8200\"}}"
  OPENBAO_API_ADDR: "{{.OPENBAO_API_ADDR | default \"https://127.0.0.1:8200\"}}"

  # Bootstrap artefacts stored as SOPS-encrypted YAML (committed).
  # Note the naming convention: *.enc.yaml is supported by .sops.yaml rules created by sops:init.
  OPENBAO_BOOTSTRAP_ENC: "{{.OPENBAO_DIR}}/bootstrap.enc.yaml"

tasks:
  # ------------------------------------------------------------------------------------------------
  # One-liner meta task
  # ------------------------------------------------------------------------------------------------
  secrets:
    desc: "Install and set up SOPS+age, SSH keys, and OpenBao baseline (safe defaults)."
    cmds:
      - task: prereqs
      - task: dirs
      - task: age:install
      - task: sops:install
      - task: age:init
      - task: sops:init
      - task: ssh:install
      - task: ssh:keys
      - task: openbao:install
      - task: openbao:configure
      - task: openbao:service
      - task: openbao:init
      - task: openbao:policies:baseline
      - task: verify
    silent: false

  # ------------------------------------------------------------------------------------------------
  # Prereqs and folder structure
  # ------------------------------------------------------------------------------------------------
  prereqs:
    desc: "Ensure base tools exist (curl, unzip, jq, openssl)."
    cmds:
      - "{{.SUDO}} {{.APT_GET}} update"
      - "{{.SUDO}} {{.APT_GET}} install -y ca-certificates curl unzip jq coreutils findutils openssl"
    status:
      - command -v curl
      - command -v unzip
      - command -v jq

  dirs:
    desc: "Create secrets folder structure (safe defaults)."
    cmds:
      - "mkdir -p {{.AGE_DIR}} {{.SOPS_DIR}} {{.OPENBAO_DIR}}"
      # - |
      #   # Compatibility: older runs used ./secrets/* paths. Keep that working without duplicating data.
      #   # This makes scripts that reference secrets/... transparently point at state/secrets/....
      #   if [ ! -e "secrets" ]; then
      #     ln -s "state/secrets" "secrets"
      #   fi
      - "mkdir -p ansible/group_vars/all ansible/group_vars/prod ansible/group_vars/dev"
      - "chmod 700 {{.AGE_DIR}}"
      - "chmod 755 {{.SOPS_DIR}} {{.OPENBAO_DIR}}"
    status:
      - test -d "{{.AGE_DIR}}"
      - test -d "{{.SOPS_DIR}}"
      - test -d "{{.OPENBAO_DIR}}"

  # ------------------------------------------------------------------------------------------------
  # age (preferred recipient mechanism for SOPS)
  # ------------------------------------------------------------------------------------------------
  age:install:
    desc: "Install age (includes age-keygen). Prefer apt; fallback to GitHub release."
    cmds:
      - |
        set -euo pipefail

        if command -v age >/dev/null 2>&1 && command -v age-keygen >/dev/null 2>&1; then
          echo "age and age-keygen already installed."
          exit 0
        fi

        # Prefer apt on Ubuntu/Debian. Enable Universe on Ubuntu if needed.
        if command -v lsb_release >/dev/null 2>&1; then
          DISTRO="$(lsb_release -is || true)"
        else
          DISTRO=""
        fi

        if [ "${DISTRO}" = "Ubuntu" ]; then
          if ! grep -RhsE '^[^#].*\bubuntu.com/ubuntu\b.*\b(universe)\b' /etc/apt/sources.list /etc/apt/sources.list.d/*.list 2>/dev/null | grep -q universe; then
            echo "Enabling Ubuntu universe repository (required for age on many images)..."
            {{.SUDO}} {{.APT_GET}} update -qq || true
            {{.SUDO}} {{.APT_GET}} install -y software-properties-common
            {{.SUDO}} add-apt-repository -y universe
          fi
        fi

        {{.SUDO}} {{.APT_GET}} update
        if {{.APT_GET}} -qq show age >/dev/null 2>&1; then
          {{.SUDO}} {{.APT_GET}} install -y age
        fi

        if command -v age >/dev/null 2>&1 && command -v age-keygen >/dev/null 2>&1; then
          echo "age installed via apt."
          exit 0
        fi

        echo "Installing age from GitHub release (fallback)..."
        TMP="$(mktemp -d)"
        trap 'rm -rf "${TMP}"' EXIT

        ARCH="$(uname -m)"
        case "${ARCH}" in
          x86_64|amd64)   AGE_ARCH="linux-amd64" ;;
          aarch64|arm64)  AGE_ARCH="linux-arm64" ;;
          *)
            echo "Unsupported architecture for age fallback: ${ARCH}"
            exit 1
            ;;
        esac

        TAG="$(curl -fsSL https://api.github.com/repos/FiloSottile/age/releases/latest | jq -r '.tag_name')"
        [ -n "${TAG}" ] && [ "${TAG}" != "null" ]

        curl -fsSL -o "${TMP}/age.tar.gz" "https://github.com/FiloSottile/age/releases/download/${TAG}/age-${TAG}-${AGE_ARCH}.tar.gz"
        tar -xzf "${TMP}/age.tar.gz" -C "${TMP}"

        {{.SUDO}} install -m 0755 "${TMP}/age/age" /usr/local/bin/age
        {{.SUDO}} install -m 0755 "${TMP}/age/age-keygen" /usr/local/bin/age-keygen

        command -v age >/dev/null 2>&1
        command -v age-keygen >/dev/null 2>&1
        echo "age installed via GitHub release fallback."
    status:
      - command -v age
      - command -v age-keygen

  age:init:
    desc: "Create an age identity (private) and recipients list (public) for repo encryption."
    cmds:
      - |
        set -euo pipefail

        mkdir -p "{{.AGE_DIR}}"
        chmod 700 "{{.AGE_DIR}}"

        if [ ! -f "{{.AGE_IDENTITY_FILE}}" ]; then
          echo "Generating age identity at {{.AGE_IDENTITY_FILE}}"
          age-keygen -o "{{.AGE_IDENTITY_FILE}}"
          chmod 600 "{{.AGE_IDENTITY_FILE}}"
        else
          echo "age identity already exists: {{.AGE_IDENTITY_FILE}}"
        fi

        PUB="$(grep -E '^# public key:' -m 1 "{{.AGE_IDENTITY_FILE}}" | awk '{print $4}')"
        if [ -z "${PUB}" ]; then
          echo "Could not extract public key from {{.AGE_IDENTITY_FILE}}"
          exit 1
        fi

        echo "${PUB}" > "{{.AGE_RECIPIENTS_FILE}}"
        chmod 644 "{{.AGE_RECIPIENTS_FILE}}"

        echo
        echo "Public recipient written to {{.AGE_RECIPIENTS_FILE}}:"
        echo "  ${PUB}"
        echo
        echo "Important: do not commit {{.AGE_IDENTITY_FILE}} to Git."
    status:
      - test -f "{{.AGE_IDENTITY_FILE}}"
      - test -f "{{.AGE_RECIPIENTS_FILE}}"

  # ------------------------------------------------------------------------------------------------
  # SOPS (Git-encrypted files using age recipients)
  # ------------------------------------------------------------------------------------------------
  sops:install:
    desc: "Install SOPS (prefers apt; falls back to GitHub release)."
    cmds:
      - |
        set -euo pipefail
        if command -v sops >/dev/null 2>&1; then
          echo "sops already installed."
          exit 0
        fi

        if {{.APT_GET}} -qq show sops >/dev/null 2>&1; then
          {{.SUDO}} {{.APT_GET}} install -y sops
          exit 0
        fi

        echo "Installing sops from GitHub latest release..."
        TMP="$(mktemp -d)"
        trap 'rm -rf "${TMP}"' EXIT

        TAG="$(curl -fsSL https://api.github.com/repos/getsops/sops/releases/latest | jq -r '.tag_name')"
        [ -n "${TAG}" ] && [ "${TAG}" != "null" ]

        ARCH="$(uname -m)"
        case "${ARCH}" in
          x86_64|amd64)   ASSET="sops-${TAG}.linux.amd64" ;;
          aarch64|arm64)  ASSET="sops-${TAG}.linux.arm64" ;;
          *)
            echo "Unsupported architecture for SOPS fallback install: ${ARCH}"
            exit 1
            ;;
        esac

        curl -fsSL -o "${TMP}/sops" "https://github.com/getsops/sops/releases/download/${TAG}/${ASSET}"
        chmod +x "${TMP}/sops"
        {{.SUDO}} install -m 0755 "${TMP}/sops" /usr/local/bin/sops
    status:
      - command -v sops

  sops:init:
    desc: "Create .sops.yaml and repo guardrails for encrypting configuration state."
    cmds:
      - |
        set -euo pipefail

        if [ ! -f "{{.AGE_RECIPIENTS_FILE}}" ]; then
          echo "Missing recipients file: {{.AGE_RECIPIENTS_FILE}} (run: task -t tasks/secrets.Taskfile.yml age:init)"
          exit 1
        fi

        RECIPIENT="$(head -n 1 "{{.AGE_RECIPIENTS_FILE}}")"
        if [ -z "${RECIPIENT}" ]; then
          echo "Recipients file is empty: {{.AGE_RECIPIENTS_FILE}}"
          exit 1
        fi

        if [ ! -f "{{.SOPS_CONFIG_FILE}}" ]; then
          {
            echo "# ##################################################################################################"
            echo "# File: .sops.yaml"
            echo "# Purpose:"
            echo "#   SOPS encryption rules for fouchger-homelab."
            echo "# Notes:"
            echo "#   - OpenBao rule supports both *.yaml and *.enc.yaml style naming."
            echo "# ##################################################################################################"
            echo ""
            echo "creation_rules:"
            echo "  - path_regex: ^state/secrets/sops/.*\\.(ya?ml|json|env|ini)$"
            echo "    encrypted_regex: '^(data|stringData|secrets|secret|token|password|key|keys|private|config)$'"
            echo "    age: ${RECIPIENT}"
            echo ""
            echo "  - path_regex: ^ansible/group_vars/.*/.*(secret|secrets)\\.(ya?ml|json)$"
            echo "    age: ${RECIPIENT}"
            echo ""
            echo "  - path_regex: ^state/secrets/openbao/.*(\\.enc)?\\.(ya?ml|json)$"
            echo "    age: ${RECIPIENT}"
          } > "{{.SOPS_CONFIG_FILE}}"
          echo "Created {{.SOPS_CONFIG_FILE}}"
        else
          # Ensure existing .sops.yaml supports *.enc.yaml for OpenBao.
          if grep -qE '^  - path_regex: \^state/secrets/openbao/' "{{.SOPS_CONFIG_FILE}}" \
            && ! grep -qE '^  - path_regex: \^state/secrets/openbao/.*\\\(\\\.enc\\\)\?' "{{.SOPS_CONFIG_FILE}}"; then
            echo "Updating {{.SOPS_CONFIG_FILE}} to support state/secrets/openbao/*.enc.yaml ..."
            {{.SUDO}} sed -i -E 's#\^state/secrets/openbao/\.\*\\\.\(ya\?ml\|json\)\$#^state/secrets/openbao/.*(\\\.enc)?\\\.(ya?ml|json)$#' "{{.SOPS_CONFIG_FILE}}" || true
          fi
          echo "{{.SOPS_CONFIG_FILE}} already exists (no destructive changes made)."
        fi

        if [ ! -f ".gitignore" ]; then
          touch .gitignore
        fi

        # Guardrails: ignore private key material regardless of whether callers reference
        # the preferred state/secrets path or the legacy ./secrets symlink.
        if ! grep -qE '^state/secrets/age/' .gitignore; then
          {
            echo ""
            echo "# Secrets tooling private material (do not commit)"
            echo "state/secrets/age/"
          } >> .gitignore
        fi

        if ! grep -qE '^secrets/age/' .gitignore; then
          {
            echo "secrets/age/"
          } >> .gitignore
        fi

        if [ ! -f "{{.SOPS_DIR}}/README.md" ]; then
          {
            echo "# Encrypted secrets (SOPS)"
            echo ""
            echo "Store Git-encrypted configuration state here (YAML/JSON/ENV/INI)."
            echo ""
            echo "Do not store age private keys here. Those live under state/secrets/age/ which is ignored by Git."
          } > "{{.SOPS_DIR}}/README.md"
        fi

  sops:encrypt:
    desc: "Encrypt a file in-place with SOPS (usage: task sops:encrypt -- FILE=path)."
    vars:
      FILE: "{{.FILE}}"
    cmds:
      - |
        set -euo pipefail
        [ -n "{{.FILE}}" ] || (echo "FILE is required, e.g. task sops:encrypt -- FILE=state/secrets/sops/app.yaml" && exit 1)
        sops -e -i "{{.FILE}}"

  sops:decrypt:
    desc: "Decrypt a file to stdout (usage: task sops:decrypt -- FILE=path)."
    vars:
      FILE: "{{.FILE}}"
    cmds:
      - |
        set -euo pipefail
        [ -n "{{.FILE}}" ] || (echo "FILE is required, e.g. task sops:decrypt -- FILE=state/secrets/sops/app.yaml" && exit 1)
        sops -d "{{.FILE}}"

  # ------------------------------------------------------------------------------------------------
  # SSH keys and agent basics (for Git + host access)
  # ------------------------------------------------------------------------------------------------
  ssh:install:
    desc: "Install SSH client tooling and optional helper utilities."
    cmds:
      - "{{.SUDO}} {{.APT_GET}} update"
      - "{{.SUDO}} {{.APT_GET}} install -y openssh-client openssh-server keychain"
    status:
      - command -v ssh
      - command -v ssh-keygen
      - command -v keychain

  ssh:keys:
    desc: "Create SSH keys (ed25519) for the current user if missing."
    vars:
      SSH_KEY: "{{.SSH_KEY | default (printf \"%s/.ssh/id_ed25519\" .HOME)}}"
      SSH_COMMENT: "{{.SSH_COMMENT | default \"fouchger-homelab\"}}"
    cmds:
      - |
        set -euo pipefail

        mkdir -p "$(dirname "{{.SSH_KEY}}")"
        chmod 700 "$(dirname "{{.SSH_KEY}}")"

        if [ -f "{{.SSH_KEY}}" ]; then
          echo "SSH key already exists: {{.SSH_KEY}}"
        else
          echo "Creating SSH key: {{.SSH_KEY}}"
          echo "You will be prompted for a passphrase (recommended)."
          ssh-keygen -t ed25519 -a 64 -C "{{.SSH_COMMENT}}" -f "{{.SSH_KEY}}"
          chmod 600 "{{.SSH_KEY}}"
          chmod 644 "{{.SSH_KEY}}.pub"
        fi

        echo
        echo "Public key:"
        cat "{{.SSH_KEY}}.pub"
        echo

        # Only append a keychain snippet if keychain exists (prevents noisy headless nodes).
        if command -v keychain >/dev/null 2>&1; then
          if [ -f "${HOME}/.bashrc" ] && ! grep -q "keychain.*id_ed25519" "${HOME}/.bashrc"; then
            {
              echo ""
              echo "# fouchger-homelab: SSH agent convenience (headless friendly)"
              echo "# Keychain manages an ssh-agent across sessions."
              echo "if command -v keychain >/dev/null 2>&1; then"
              echo "  eval \"$(keychain --eval --quiet id_ed25519)\""
              echo "fi"
            } >> "${HOME}/.bashrc"
            echo "Updated ~/.bashrc with keychain snippet (effective on next shell start)."
          fi
        else
          echo "keychain not installed; skipping ~/.bashrc snippet."
        fi

  # ------------------------------------------------------------------------------------------------
  # OpenBao (dynamic secrets, audit, policies)
  # ------------------------------------------------------------------------------------------------
  openbao:install:
    desc: "Install OpenBao CLI/server (prefers .deb; falls back to snap)."
    cmds:
      - |
        set -euo pipefail

        # Already installed?
        if command -v bao >/dev/null 2>&1; then
          echo "OpenBao already installed (bao on PATH)."
          exit 0
        fi

        # Some installs expose `openbao` rather than `bao` (common with snap).
        if command -v openbao >/dev/null 2>&1; then
          echo "OpenBao detected as 'openbao'. Creating /usr/local/bin/bao symlink..."
          {{.SUDO}} install -d /usr/local/bin
          {{.SUDO}} ln -sf "$(command -v openbao)" /usr/local/bin/bao
          command -v bao >/dev/null 2>&1
          echo "OpenBao ready (openbao -> bao)."
          exit 0
        fi

        {{.SUDO}} {{.APT_GET}} update
        {{.SUDO}} {{.APT_GET}} install -y ca-certificates curl jq

        # Choose version tag
        if [ "{{.OPENBAO_VERSION}}" = "latest" ]; then
          TAG="$(curl -fsSL https://api.github.com/repos/openbao/openbao/releases/latest | jq -r '.tag_name')"
        else
          TAG="{{.OPENBAO_VERSION}}"
        fi
        [ -n "${TAG}" ] && [ "${TAG}" != "null" ]

        # Detect architecture and expected .deb suffix
        ARCH="$(uname -m)"
        case "${ARCH}" in
          x86_64|amd64)   DEB_ARCH="amd64" ;;
          aarch64|arm64)  DEB_ARCH="arm64" ;;
          *)
            echo "Unsupported architecture for OpenBao: ${ARCH}"
            exit 1
            ;;
        esac

        echo "Attempting .deb install for OpenBao ${TAG} (${DEB_ARCH})..."

        # Find a .deb asset URL in the release (names can vary; match on linux + arch + .deb).
        DEB_URL="$(
          curl -fsSL "https://api.github.com/repos/openbao/openbao/releases/tags/${TAG}" \
          | jq -r --arg arch "${DEB_ARCH}" '
              .assets[]
              | select(.browser_download_url | test("linux.*" + $arch + ".*\\.deb$"))
              | .browser_download_url
            ' \
          | head -n 1
        )"

        if [ -n "${DEB_URL}" ] && [ "${DEB_URL}" != "null" ]; then
          TMP="$(mktemp -d)"
          trap 'rm -rf "${TMP}"' EXIT

          DEB_FILE="${TMP}/openbao-${TAG#v}-linux-${DEB_ARCH}.deb"
          echo "Downloading: ${DEB_URL}"
          curl -fsSL -o "${DEB_FILE}" "${DEB_URL}"

          echo "Installing .deb with dpkg..."
          {{.SUDO}} dpkg -i "${DEB_FILE}" || true
          echo "Fixing dependencies (if needed)..."
          {{.SUDO}} {{.APT_GET}} install -f -y

          # Validate command presence (bao preferred)
          if command -v bao >/dev/null 2>&1; then
            echo "OpenBao installed via .deb (bao available)."
            exit 0
          fi

          # If package exposes openbao instead, symlink to bao.
          if command -v openbao >/dev/null 2>&1; then
            {{.SUDO}} install -d /usr/local/bin
            {{.SUDO}} ln -sf "$(command -v openbao)" /usr/local/bin/bao
            command -v bao >/dev/null 2>&1
            echo "OpenBao installed via .deb (openbao -> bao)."
            exit 0
          fi

          echo "Installed .deb but neither 'bao' nor 'openbao' found. Check package contents."
          exit 1
        fi

        echo "No matching .deb asset found for ${TAG} (${DEB_ARCH}). Falling back to snap..."

        if ! command -v snap >/dev/null 2>&1; then
          {{.SUDO}} {{.APT_GET}} install -y snapd
        fi

        # Ensure /snap/bin is on PATH for non-login shells
        if [ -d /snap/bin ] && ! echo "${PATH}" | grep -q "/snap/bin"; then
          export PATH="${PATH}:/snap/bin"
        fi

        {{.SUDO}} snap install openbao

        if command -v bao >/dev/null 2>&1; then
          echo "OpenBao installed via snap (bao available)."
          exit 0
        fi

        if command -v openbao >/dev/null 2>&1; then
          {{.SUDO}} install -d /usr/local/bin
          {{.SUDO}} ln -sf "$(command -v openbao)" /usr/local/bin/bao
          command -v bao >/dev/null 2>&1
          echo "OpenBao installed via snap (openbao -> bao)."
          exit 0
        fi

        if [ -x /snap/bin/openbao ]; then
          {{.SUDO}} install -d /usr/local/bin
          {{.SUDO}} ln -sf /snap/bin/openbao /usr/local/bin/bao
          command -v bao >/dev/null 2>&1
          echo "OpenBao installed via snap (/snap/bin/openbao -> bao)."
          exit 0
        fi

        echo "OpenBao installed but CLI not found on PATH. Log out/in or restart, then retry."
        exit 1
    status:
      - command -v bao

  openbao:configure:
    desc: "Create OpenBao user, directories, and baseline config (file storage, TLS listener)."
    cmds:
      - |
        set -euo pipefail

        if ! getent group "{{.OPENBAO_GROUP}}" >/dev/null; then
          {{.SUDO}} groupadd --system "{{.OPENBAO_GROUP}}"
        fi
        if ! id -u "{{.OPENBAO_USER}}" >/dev/null 2>&1; then
          {{.SUDO}} useradd --system --home "{{.OPENBAO_DATA_DIR}}" --shell /usr/sbin/nologin --gid "{{.OPENBAO_GROUP}}" "{{.OPENBAO_USER}}"
        fi

        {{.SUDO}} mkdir -p "{{.OPENBAO_CONFIG_DIR}}" "{{.OPENBAO_DATA_DIR}}"
        {{.SUDO}} chown -R "{{.OPENBAO_USER}}:{{.OPENBAO_GROUP}}" "{{.OPENBAO_CONFIG_DIR}}" "{{.OPENBAO_DATA_DIR}}"
        {{.SUDO}} chmod 750 "{{.OPENBAO_CONFIG_DIR}}" "{{.OPENBAO_DATA_DIR}}"

        # TLS cert/key location (homelab default).
        {{.SUDO}} mkdir -p "{{.OPENBAO_CONFIG_DIR}}/tls"
        {{.SUDO}} chown -R "{{.OPENBAO_USER}}:{{.OPENBAO_GROUP}}" "{{.OPENBAO_CONFIG_DIR}}/tls"
        {{.SUDO}} chmod 750 "{{.OPENBAO_CONFIG_DIR}}/tls"

        # Generate a local self-signed cert if missing.
        if [ ! -f "{{.OPENBAO_CONFIG_DIR}}/tls/openbao.crt" ] || [ ! -f "{{.OPENBAO_CONFIG_DIR}}/tls/openbao.key" ]; then
          echo "Generating self-signed TLS cert for OpenBao (homelab default)..."
          TMPDIR="$(mktemp -d)"
          trap 'rm -rf "${TMPDIR}"' EXIT

          openssl req -x509 -newkey rsa:4096 -sha256 -days 825 -nodes \
            -keyout "${TMPDIR}/openbao.key" \
            -out "${TMPDIR}/openbao.crt" \
            -subj "/CN=openbao" \
            -addext "subjectAltName=DNS:openbao,DNS:localhost,IP:127.0.0.1"

          {{.SUDO}} install -m 0640 -o "{{.OPENBAO_USER}}" -g "{{.OPENBAO_GROUP}}" "${TMPDIR}/openbao.key" "{{.OPENBAO_CONFIG_DIR}}/tls/openbao.key"
          {{.SUDO}} install -m 0644 -o "{{.OPENBAO_USER}}" -g "{{.OPENBAO_GROUP}}" "${TMPDIR}/openbao.crt" "{{.OPENBAO_CONFIG_DIR}}/tls/openbao.crt"
        fi

        # Create or update OpenBao config to TLS mode.
        # IMPORTANT:
        #   We update the existing file in-place if it exists, to avoid the "already exists" drift you hit.
        if [ ! -f "{{.OPENBAO_CONFIG_DIR}}/openbao.hcl" ]; then
          touch "{{.OPENBAO_CONFIG_DIR}}/openbao.hcl"
          {{.SUDO}} chown "{{.OPENBAO_USER}}:{{.OPENBAO_GROUP}}" "{{.OPENBAO_CONFIG_DIR}}/openbao.hcl"
          {{.SUDO}} chmod 640 "{{.OPENBAO_CONFIG_DIR}}/openbao.hcl"
        fi

        {
          echo "# ##################################################################################################"
          echo "# File: /etc/openbao/openbao.hcl"
          echo "# Purpose:"
          echo "#   Baseline OpenBao configuration for a homelab (TLS enabled)."
          echo "# Notes:"
          echo "#   - Self-signed TLS by default. Replace with internal CA when ready."
          echo "# ##################################################################################################"
          echo ""
          echo "ui = true"
          echo "api_addr = \"{{.OPENBAO_API_ADDR}}\""
          echo ""
          echo "storage \"file\" {"
          echo "  path = \"{{.OPENBAO_DATA_DIR}}\""
          echo "}"
          echo ""
          echo "listener \"tcp\" {"
          echo "  address = \"{{.OPENBAO_LISTEN_ADDRESS}}\""
          echo "  tls_disable = 0"
          echo "  tls_cert_file = \"{{.OPENBAO_CONFIG_DIR}}/tls/openbao.crt\""
          echo "  tls_key_file  = \"{{.OPENBAO_CONFIG_DIR}}/tls/openbao.key\""
          echo "}"
          echo ""
          echo "disable_mlock = true"
        } > /tmp/openbao.hcl

        {{.SUDO}} install -m 0640 -o "{{.OPENBAO_USER}}" -g "{{.OPENBAO_GROUP}}" /tmp/openbao.hcl "{{.OPENBAO_CONFIG_DIR}}/openbao.hcl"
        rm -f /tmp/openbao.hcl

  openbao:service:
    desc: "Install and start systemd service for OpenBao."
    cmds:
      - |
        set -euo pipefail

        if [ ! -d /etc/systemd/system ]; then
          echo "systemd not detected. Use OpenBao in dev mode or container mode on this host."
          exit 1
        fi

        # Guardrail: ensure the OpenBao CLI is resolvable for the current shell before writing a unit.
        if ! command -v "{{.OPENBAO_BIN}}" >/dev/null 2>&1; then
          echo "OpenBao CLI '{{.OPENBAO_BIN}}' not found on PATH. Run: task openbao:install"
          exit 1
        fi

        if [ ! -f "/etc/systemd/system/{{.OPENBAO_SERVICE}}.service" ]; then
          {
            echo "# ##################################################################################################"
            echo "# File: /etc/systemd/system/openbao.service"
            echo "# Purpose:"
            echo "#   Run OpenBao as a service."
            echo "# Notes:"
            echo "#   - Uses /usr/bin/env to avoid hard-coding the bao binary path."
            echo "#   - Works with /usr/bin/bao (.deb installs) and /usr/local/bin/bao (symlink/overrides)."
            echo "# ##################################################################################################"
            echo "[Unit]"
            echo "Description=OpenBao"
            echo "After=network-online.target"
            echo "Wants=network-online.target"
            echo ""
            echo "[Service]"
            echo "User={{.OPENBAO_USER}}"
            echo "Group={{.OPENBAO_GROUP}}"
            echo "ExecStart=/usr/bin/env {{.OPENBAO_BIN}} server -config={{.OPENBAO_CONFIG_DIR}}/openbao.hcl"
            echo "ExecReload=/bin/kill --signal HUP \$MAINPID"
            echo "KillMode=process"
            echo "KillSignal=SIGINT"
            echo "Restart=on-failure"
            echo "RestartSec=5"
            echo "LimitNOFILE=65536"
            echo "NoNewPrivileges=yes"
            echo "PrivateTmp=yes"
            echo "ProtectSystem=full"
            echo "ProtectHome=yes"
            echo "MemorySwapMax=0"
            echo ""
            echo "[Install]"
            echo "WantedBy=multi-user.target"
          } > /tmp/openbao.service
          {{.SUDO}} install -m 0644 /tmp/openbao.service "/etc/systemd/system/{{.OPENBAO_SERVICE}}.service"
          rm -f /tmp/openbao.service
        fi

        {{.SUDO}} systemctl daemon-reload
        {{.SUDO}} systemctl restart "{{.OPENBAO_SERVICE}}" || true
        {{.SUDO}} systemctl enable --now "{{.OPENBAO_SERVICE}}"
        {{.SUDO}} systemctl --no-pager status "{{.OPENBAO_SERVICE}}" || true

  openbao:init:
    desc: "Initialise OpenBao if not initialised, then store bootstrap info as SOPS-encrypted YAML (TLS)."
    cmds:
      - |
        set -euo pipefail

        # Option B: default to TLS and tolerate self-signed certificates for bootstrap.
        export BAO_ADDR="{{.OPENBAO_API_ADDR}}"
        export BAO_SKIP_VERIFY="${BAO_SKIP_VERIFY:-true}"

        for i in $(seq 1 30); do
          if bao status >/dev/null 2>&1; then
            break
          fi
          sleep 1
        done

        if bao status 2>/dev/null | grep -q "Initialized.*true"; then
          echo "OpenBao already initialised."
          exit 0
        fi

        echo "Initialising OpenBao (this will generate unseal keys and initial root token)."

        INIT_JSON="$(bao operator init -format=json -key-shares=5 -key-threshold=3)"
        [ -n "${INIT_JSON}" ]

        mkdir -p "{{.OPENBAO_DIR}}"

        # IMPORTANT:
        #   SOPS only encrypts files that match a creation rule. Our rules match *.enc.yaml and *.yaml.
        #   Therefore, ensure the temporary file also ends with .enc.yaml so it is covered.
        TMPFILE="$(mktemp -p "{{.OPENBAO_DIR}}" "bootstrap.tmp.XXXXXX.enc.yaml")"
        trap 'rm -f "${TMPFILE}"' EXIT

        {
          echo "openbao:"
          echo "  addr: \"{{.OPENBAO_API_ADDR}}\""
          echo "  generated_at_utc: \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\""
          echo "  init:"
          echo "    key_shares: 5"
          echo "    key_threshold: 3"
          echo "    json: |"
          echo "${INIT_JSON}" | sed 's/^/      /'
        } > "${TMPFILE}"

        sops -e -i "${TMPFILE}"
        mkdir -p "$(dirname "{{.OPENBAO_BOOTSTRAP_ENC}}")"
        mv "${TMPFILE}" "{{.OPENBAO_BOOTSTRAP_ENC}}"

        echo "Encrypted bootstrap saved to: {{.OPENBAO_BOOTSTRAP_ENC}}"

  openbao:policies:baseline:
    desc: "Create baseline secret engines and a starter policy (requires OpenBao unsealed + operator login)."
    cmds:
      - |
        set -euo pipefail
        export BAO_ADDR="{{.OPENBAO_API_ADDR}}"
        export BAO_SKIP_VERIFY="${BAO_SKIP_VERIFY:-true}"

        if ! bao token lookup >/dev/null 2>&1; then
          echo "Not logged in to OpenBao. Run: bao login (after unseal) and re-run this task."
          exit 1
        fi

        bao secrets enable -path=kv kv-v2 >/dev/null 2>&1 || true
        bao secrets enable pki >/dev/null 2>&1 || true
        bao secrets tune -max-lease-ttl=8760h pki >/dev/null 2>&1 || true

        {{.SUDO}} mkdir -p /var/log/openbao
        {{.SUDO}} chown "{{.OPENBAO_USER}}:{{.OPENBAO_GROUP}}" /var/log/openbao
        {{.SUDO}} chmod 750 /var/log/openbao

        bao audit enable file file_path=/var/log/openbao/audit.log >/dev/null 2>&1 || true

        TMPPOL="$(mktemp)"
        trap 'rm -f "${TMPPOL}"' EXIT
        {
          echo "# Baseline admin policy (starter). Tighten or split duties as the admin team grows."
          echo "path \"sys/health\" { capabilities = [\"read\", \"sudo\"] }"
          echo "path \"sys/mounts\" { capabilities = [\"read\", \"list\"] }"
          echo "path \"sys/mounts/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\", \"sudo\"] }"
          echo "path \"auth/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\", \"sudo\"] }"
          echo "path \"sys/policies/acl/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\", \"sudo\"] }"
          echo "path \"kv/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\"] }"
          echo "path \"pki/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\", \"sudo\"] }"
        } > "${TMPPOL}"

        bao policy write homelab-admin "${TMPPOL}"
        echo "Baseline engines enabled (kv-v2, pki, file audit) and policy homelab-admin created."

  verify:
    desc: "Verify installs and print operator-friendly status."
    cmds:
      - |
        set -euo pipefail
        echo "Tooling:"
        command -v age >/dev/null && echo "  age:   $(age --version 2>/dev/null || true)"
        command -v sops >/dev/null && echo "  sops:  $(sops --version 2>/dev/null | head -n 1 || true)"
        command -v bao >/dev/null && echo "  bao:   $(bao version 2>/dev/null || true)"
        command -v ssh >/dev/null && echo "  ssh:   $(ssh -V 2>&1 | head -n 1 || true)"
        echo
        echo "Repo structure:"
        test -f "{{.SOPS_CONFIG_FILE}}" && echo "  {{.SOPS_CONFIG_FILE}}: present"
        test -f "{{.AGE_IDENTITY_FILE}}" && echo "  {{.AGE_IDENTITY_FILE}}: present (private, not committed)"
        test -f "{{.AGE_RECIPIENTS_FILE}}" && echo "  {{.AGE_RECIPIENTS_FILE}}: present (public recipient)"
        test -f "{{.OPENBAO_BOOTSTRAP_ENC}}" && echo "  {{.OPENBAO_BOOTSTRAP_ENC}}: present (encrypted)"
        echo
        echo "OpenBao service:"
        if command -v systemctl >/dev/null 2>&1; then
          systemctl is-enabled "{{.OPENBAO_SERVICE}}" >/dev/null 2>&1 && echo "  enabled: yes" || echo "  enabled: no"
          systemctl is-active "{{.OPENBAO_SERVICE}}" >/dev/null 2>&1 && echo "  active:  yes" || echo "  active:  no"
        else
          echo "  systemd not detected."
        fi